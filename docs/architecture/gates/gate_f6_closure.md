# סגירת שער F6 — Gate F6 Closure Note

מטרה
---
מסמך זה תיעודי: הוא מסביר את גבולות ההוכחה עבור שער F6 (בחינת התאמה בין שווי נכסי הפוזיציות - PV, לבין מרכיבי PnL המובנים), ומסכם את ההחלטות האדריכליות שקבעו את הדרך להבטחת שימור סמנטיקות ה־PnL בפרויקט.

הגדרה מרכזית
---
- המונח `theoretical_mark_to_model` מתייחס למדיניות התמחור התיאורטית שאותה המערכת מיישמת לצורך חישוב ערכי PV פנימיים.

מגבלות חבילת ה־Golden של ה־Pipeline
---
- חבילת ה־golden המשולבת ב־pipeline מאמתת באופן מהימן ורציף את ערכי ה־PV (כלומר: תוצאות `theoretical_mark_to_model`), אך אינה מכילה מנגנון לבדיקת הסמנטיקות של מרכיבי ה־PnL (realized/unrealized) ברמת רצף האירועים והחישוב המפורט.
- כתוצאה מזה, אין אפשרות תקנית להכליל בדיקות Golden של PnL בתוך אותו pipeline מבלי להרחיב משמעותית את מסגרת ה־harness — שינוי שאינו מותר במסגרת מגבלות הגייט והסביבה הנוכחית.

שימור סמנטיקות PnL (גשר פתרון)
---
- סמנטיקות ה־realized_pnl וה־unrealized_pnl ננעלו באמצעות בדיקות יחידה ודטרמיניסטיות (tests-only), המופעלות מחוץ לזרימת ה־pipeline Golden. הבדיקות מצביעות ישירות על המימושים ב:
  - `core.pnl.realized` — חישוב realized PnL
  - `core.pnl.unrealized` — חישוב unrealized PnL
  - קובצי הבדיקות הרלוונטיים: `tests/core/test_pnl_f6_6_goldens.py`
- הבדיקות נעשות בסביבה דטרמיניסטית עם ערכי זמן וכניסות סטטיות, ומיישמות את מדיניות הדיוק המספרית של הפרויקט באמצעות `core.numeric_policy.DEFAULT_TOLERANCES` כדי להבטיח יציבות ועמידות לשוני מספרי מינורי.

הצדקה אדריכלית
---
- שמירה על ה־firewall בין שכבות ה־API וה־pipeline — אי הכנסת בדיקת PnL ל־pipeline מונעת סיכונים, שינויים בממשקי אחסון או בתלותי deployment שאינם רצויים כעת.
- שימוש בבדיקות דטרמיניסטיות חותם את ההתחייבות הפונקציונלית: כל שינוי עתידי ב־`core.pnl.*` שיפר את התוצאה ישבור את הבדיקות והתקלה תיחשף בשלב ה־CI/PR, מה שמספק רמת בטחון מספקת ללא שינוי ה־pipeline.

הנחיות להמשך
---
- כל שינוי שמשפיע על החישובים התיאורטיים של PV או על מרכיבי PnL חייב לכלול עדכון או הוספת בדיקות דטרמיניסטיות מתאימות ב־`tests/core/` ובשיטת ההשוואה ל־`DEFAULT_TOLERANCES`.
- במידה שבעתיד תתקבל החלטה מוסכמת להרחיב את ה־pipeline Golden כך שיכלול בדיקות PnL, יש להכין מפרט מפורט שיתאר את מנגנון האירועים, פורמט ה־golden והבטחת דטרמיניזם לזיהוי שינויים.

חתימה
---
תיעוד זה מסביר את סגירת שער F6 בכל הנוגע ל־PV ו־PnL תחת המגבלות הארגוניות והטכניות הקיימות.

תאריך: (נוצר אוטומטית במסגרת PR)
